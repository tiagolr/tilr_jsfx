desc:WizRes
author: tilr
version: 1.0.0
changelog:
  First
about:
  # WizRes
tags: synth, instrument

<? npartials < 1 ? npartials = 32 ?>
<? npolyphony < 1 ? npolyphony = 8 ?>
config: npartials "Partials" 32 4 16 32 64
config: npolyphony "Polyphony" 4 8 12 16

slider1:/tilr8_WizClick:none:Click
slider2:click_vol=80<0, 100, .01>Volume
slider3:click_pitch=0<-24,24,1>Pitch
slider4:click_ktrack=0<0,1,1{No, Yes}>KeyTrack

slider6:model=0<0,6,1{String,Beam,Metal,Membrane,Plate,Drumhead,Marimba}>Model
slider7:decay=1<0.01,100,0.01:log>Decay
slider8:freq_damp=0<-100,100,0.1>Material
slider9:tone=0<-100,100,0.1>Tone
slider10:hit_position=26<2,50,0.1>Hit Position
slider11:release=100<0,100,0.1>Release
slider12:inharmonic=0.01<0.01,100,0.001:log>Inharmonic
slider13:ratio=1<0.1,10,0.01:log>Ratio

import ws.array.jsfx-inc

@init
ext_noinit = 1;
<? printf("npartials = %d;\n", npartials); ?>
lfile = -1;
wavechn = 0;
wavesrate = 0;
wavelen = 0;
base_note = 60;
playback_speed = 1;
freemem = 100000;

// string model: fk = k
string = freemem; freemem += 64;
string[0] = 0;string[1] = 1;string[2] = 2;string[3] = 3;string[4] = 4;string[5] = 5;string[6] = 6;string[7] = 7;string[8] = 8;string[9] = 9;string[10] = 10;string[11] = 11;string[12] = 12;string[13] = 13;string[14] = 14;string[15] = 15;string[16] = 16;string[17] = 17;string[18] = 18;string[19] = 19;string[20] = 20;string[21] = 21;string[22] = 22;string[23] = 23;string[24] = 24;string[25] = 25;string[26] = 26;string[27] = 27;string[28] = 28;string[29] = 29;string[30] = 30;string[31] = 31;string[32] = 32;string[33] = 33;string[34] = 34;string[35] = 35;string[36] = 36;string[37] = 37;string[38] = 38;string[39] = 39;string[40] = 40;string[41] = 41;string[42] = 42;string[43] = 43;string[44] = 44;string[45] = 45;string[46] = 46;string[47] = 47;string[48] = 48;string[49] = 49;string[50] = 50;string[51] = 51;string[52] = 52;string[53] = 53;string[54] = 54;string[55] = 55;string[56] = 56;string[57] = 57;string[58] = 58;string[59] = 59;string[60] = 60;string[61] = 61;string[62] = 62;string[63] = 63;
// beam model: fmn *= sqrt(m**4 + (2*Bfree[n])**4)
// where Bfree[n] is the nth solution of cos($pi*x) = 1/cos($pi*x)
// https://nathan.ho.name/posts/exploring-modal-synthesis
beam = freemem; freemem += 64;
beam[0] = 1.0;beam[1] = 2.742118730723096;beam[2] = 5.372437705395023;beam[3] = 8.879796231350905;beam[4] = 13.26432297929055;beam[5] = 18.525894832548836;beam[6] = 24.664464701923304;beam[7] = 31.680011427264994;beam[8] = 39.57480167993186;beam[9] = 48.34386187557112;beam[10] = 57.98998201587341;beam[11] = 68.51312839987956;beam[12] = 79.91327932335997;beam[13] = 92.19042029669127;beam[14] = 105.34454134738507;beam[15] = 119.37563542989709;beam[16] = 134.286605658006;beam[17] = 150.07132597088105;beam[18] = 166.73305349293955;beam[19] = 184.27177735520195;beam[20] = 202.68748915580662;beam[21] = 221.9801823173097;beam[22] = 242.14985163115497;beam[23] = 263.1964929295172;beam[24] = 285.1237904740257;beam[25] = 307.92409320904443;beam[26] = 331.6013888047332;beam[27] = 356.1556713642617;beam[28] = 381.58693597293706;beam[29] = 407.89517850825996;beam[30] = 435.08039549149447;beam[31] = 463.1425839706985;beam[32] = 492.0862467609114;beam[33] = 521.9021136490643; beam[34] = 552.5949669402571; beam[35] = 584.164802709515;  beam[36] = 616.6116175480827; beam[37] = 649.9354084840451; beam[38] = 684.1361729168341; beam[39] = 719.2139085629082; beam[40] = 755.1739518807949; beam[41] = 792.0053758900387; beam[42] = 829.7137826702212; beam[43] = 868.2991693165571; beam[44] = 907.7615332399005; beam[45] = 948.1008721264657; beam[46] = 989.3171839034187; beam[47] = 1031.4104667093834;beam[48] = 1074.3868982163283;beam[49] = 1118.233875919467; beam[50] = 1162.9578340759736;beam[51] = 1208.5587703942417;beam[52] = 1255.0366827948008;beam[53] = 1302.3915693871795;beam[54] = 1350.6234284496627;beam[55] = 1399.7322584115318;beam[56] = 1449.7250824905104;beam[57] = 1500.5876119645127;beam[58] = 1552.3271202881517;beam[59] = 1604.9436055754263;beam[60] = 1658.4370660924033;beam[61] = 1712.8075002427393;beam[62] = 1768.0549065547818;beam[63] = 1824.179283670064;
// metal model: fk *= k**2
metal = freemem; freemem += 64;
metal[0] = 1.0;metal[1] = 4.0;metal[2] = 9.0;metal[3] = 16.0;metal[4] = 24.999999999999996;metal[5] = 36.0;metal[6] = 49.0;metal[7] = 64.0;metal[8] = 81.0;metal[9] = 99.99999999999999;metal[10] = 121.0;metal[11] = 144.0;metal[12] = 169.0;metal[13] = 196.0;metal[14] = 225.0;metal[15] = 256.0;metal[16] = 289.0;metal[17] = 324.0;metal[18] = 361.0;metal[19] = 399.99999999999994;metal[20] = 441.0;metal[21] = 484.0;metal[22] = 529.0;metal[23] = 576.0;metal[24] = 625.0;metal[25] = 676.0;metal[26] = 729.0;metal[27] = 784.0;metal[28] = 840.9999999999999;metal[29] = 900.0;metal[30] = 961.0;metal[31] = 1024.0;metal[32] = 1089.0;metal[33] = 1156.0;metal[34] = 1225.0;metal[35] = 1296.0;metal[36] = 1369.0;metal[37] = 1444.0;metal[38] = 1521.0;metal[39] = 1599.9999999999998;metal[40] = 1680.9999999999998;metal[41] = 1764.0;metal[42] = 1849.0;metal[43] = 1936.0;metal[44] = 2024.9999999999998;metal[45] = 2116.0;metal[46] = 2209.0;metal[47] = 2304.0;metal[48] = 2401.0;metal[49] = 2500.0;metal[50] = 2601.0;metal[51] = 2704.0;metal[52] = 2808.9999999999995;metal[53] = 2916.0;metal[54] = 3025.0;metal[55] = 3136.0;metal[56] = 3248.9999999999995;metal[57] = 3363.9999999999995;metal[58] = 3481.0;metal[59] = 3600.0;metal[60] = 3720.9999999999995;metal[61] = 3844.0;metal[62] = 3968.9999999999995;metal[63] = 4096.0;
// membrane model: fmn *= sqrt(m**2 + (0.78*n)**2)
membrane = freemem; freemem += 64;
membrane[0] = 1.0;membrane[1] = 1.46109285817633;membrane[2] = 2.0065176070089703;membrane[3] = 2.583401188563129;membrane[4] = 3.17463993575823;membrane[5] = 3.773492277607296;membrane[6] = 4.376834180480457;membrane[7] = 4.983035133780558;membrane[8] = 1.6926924291749292;membrane[9] = 2.0;membrane[10] = 2.427204269735683;membrane[11] = 2.92218571635266;membrane[12] = 3.455943631122641;membrane[13] = 4.013035214017941;membrane[14] = 4.584962933678762;membrane[15] = 5.166802377126258;membrane[16] = 2.4441536557186816;membrane[17] = 2.6662106880321503;membrane[18] = 3.0;membrane[19] = 3.4128944891151236;membrane[20] = 3.8797198113361246;membrane[21] = 4.38327857452899;membrane[22] = 4.912287098306147;membrane[23] = 5.459352181097535;membrane[24] = 3.213415363586011;membrane[25] = 3.3853848583498585;membrane[26] = 3.6540595515354726;membrane[27] = 4.0;membrane[28] = 4.405039956758808;membrane[29] = 4.854408539471366;membrane[30] = 5.336920061454232;membrane[31] = 5.84437143270532;membrane[32] = 3.990195644111825;membrane[33] = 4.129945958302949;membrane[34] = 4.352904109387891;membrane[35] = 4.647109099145228;membrane[36] = 5.0;membrane[37] = 5.400083818557902;membrane[38] = 5.837665519855606;membrane[39] = 6.304942539213217;membrane[40] = 4.770823412246371;membrane[41] = 4.888307311437363;membrane[42] = 5.078077287524788;membrane[43] = 5.332421376064301;membrane[44] = 5.6426141771832246;membrane[45] = 6.0;membrane[46] = 6.3966736257417525;membrane[47] = 6.825788978230247;membrane[48] = 5.553676490089963;membrane[49] = 5.654919530531964;membrane[50] = 5.819745309187935;membrane[51] = 6.042953272833355;membrane[52] = 6.318359065318225;membrane[53] = 6.639470349789949;membrane[54] = 7.0;membrane[55] = 7.394184316141261;membrane[56] = 6.337930329019764;membrane[57] = 6.426830727172022;membrane[58] = 6.5723263585085;membrane[59] = 6.770769716699717;membrane[60] = 7.017670523558341;membrane[61] = 7.308119103070945;membrane[62] = 7.63714857122281;membrane[63] = 8.0;

// plate model: fmn *= m**2 + (0.78*n)**2
plate = freemem; freemem += 64;
plate[0] = 1.0;plate[1] = 2.134792340213877;plate[2] = 4.026112907237005;plate[3] = 6.673961701069386;plate[4] = 10.078338721711017;plate[5] = 14.239243969161897;plate[6] = 19.156677443422033;plate[7] = 24.83063914449142;plate[8] = 2.8652076597861225;plate[9] = 4.0;plate[10] = 5.891320567023128;plate[11] = 8.539169360855508;plate[12] = 11.943546381497141;plate[13] = 16.10445162894802;plate[14] = 21.021885103208156;plate[15] = 26.695846804277544;plate[16] = 5.973887092762994;plate[17] = 7.108679432976872;plate[18] = 9.0;plate[19] = 11.647848793832381;plate[20] = 15.052225814474012;plate[21] = 19.21313106192489;plate[22] = 24.130564536185027;plate[23] = 29.804526237254414;plate[24] = 10.326038298930614;plate[25] = 11.46083063914449;plate[26] = 13.352151206167619;plate[27] = 16.0;plate[28] = 19.404377020641633;plate[29] = 23.565282268092513;plate[30] = 28.482715742352646;plate[31] = 34.15667744342203;plate[32] = 15.921661278288981;plate[33] = 17.056453618502857;plate[34] = 18.947774185525986;plate[35] = 21.595622979358367;plate[36] = 25.0;plate[37] = 29.16090524745088;plate[38] = 34.07833872171101;plate[39] = 39.7523004227804;plate[40] = 22.760756030838103;plate[41] = 23.895548371051976;plate[42] = 25.786868938075106;plate[43] = 28.434717731907487;plate[44] = 31.839094752549116;plate[45] = 36.0;plate[46] = 40.91743347426013;plate[47] = 46.591395175329524;plate[48] = 30.843322556577967;plate[49] = 31.97811489679184;plate[50] = 33.86943546381497;plate[51] = 36.517284257647354;plate[52] = 39.92166127828899;plate[53] = 44.082566525739864;plate[54] = 49.0;plate[55] = 54.67396170106939;plate[56] = 40.16936085550858;plate[57] = 41.304153195722456;plate[58] = 43.195473762745586;plate[59] = 45.84332255657796;plate[60] = 49.2476995772196;plate[61] = 53.408604824670476;plate[62] = 58.32603829893061;plate[63] = 64.0;
// drumhead model: fmn *= Jmn
// where Jmn is the bessel root(m,n)
drumhead = freemem; freemem += 64;
drumhead[0] = 1.0;drumhead[1] = 1.593340505695112;drumhead[2] = 2.1355487866494034;drumhead[3] = 2.295417267427694;drumhead[4] = 2.6530664045492145;drumhead[5] = 2.9172954551172228;drumhead[6] = 3.155464815408362;drumhead[7] = 3.5001474903090264;drumhead[8] = 3.5984846739581138;drumhead[9] = 3.6474511791052775;drumhead[10] = 4.058931883331434;drumhead[11] = 4.131738159726707;drumhead[12] = 4.230439127905234;drumhead[13] = 4.6010445344331075;drumhead[14] = 4.610051645437306;drumhead[15] = 4.831885262930598;drumhead[16] = 4.903280573212368;drumhead[17] = 5.1307689067016575;drumhead[18] = 5.412118429982582;drumhead[19] = 5.5403985098530635;drumhead[20] = 5.650842376925684;drumhead[21] = 5.976540221648715;drumhead[22] = 6.152609171589257;drumhead[23] = 6.1631367313038865;drumhead[24] = 6.208732130572546;drumhead[25] = 6.528612451522295;drumhead[26] = 6.746213299505839;drumhead[27] = 6.848991602808508;drumhead[28] = 7.0707081490386905;drumhead[29] = 7.325257332462771;drumhead[30] = 7.468242109085181;drumhead[31] = 7.514500962483965;drumhead[32] = 7.604536126938166;drumhead[33] = 7.892520026843893;drumhead[34] = 8.071028338967128;drumhead[35] = 8.1568737689496;drumhead[36] = 8.45000551018646;drumhead[37] = 8.66047555520746;drumhead[38] = 8.781093075730398;drumhead[39] = 8.820447105611922;drumhead[40] = 8.999214496283312;drumhead[41] = 9.238840557670077;drumhead[42] = 9.390589484063241;drumhead[43] = 9.464339027734203;drumhead[44] = 9.807815107462856;drumhead[45] = 9.98784275554081;drumhead[46] = 10.092254814868133;drumhead[47] = 10.126502295693772;drumhead[48] = 10.368705458854519;drumhead[49] = 10.574713443493692;drumhead[50] = 10.706875023386747;drumhead[51] = 10.77153891878896;drumhead[52] = 11.152639282954734;drumhead[53] = 11.310212368186301;drumhead[54] = 11.402312929615599;drumhead[55] = 11.722758172320448;drumhead[56] = 11.903823217314876;drumhead[57] = 12.020976194473256;drumhead[58] = 12.48894011894477;drumhead[59] = 12.6291936518746;drumhead[60] = 13.066558649839825;drumhead[61] = 13.228284530761863;drumhead[62] = 13.819314942198952;drumhead[63] = 14.40316086180383;
// marimba model: I couldn't program this one, instead the model was obtained
// from frequency analysis on a marimba sampled from chromaphone
marimba = freemem; freemem += 64;
marimba[0] = 1.0;marimba[1] = 3.9393939393939394;marimba[2] = 10.575757575757576;marimba[3] = 19.0;marimba[4] = 26.757575757575758;marimba[5] = 36.93939393939394;marimba[6] = 49.18181818181818;marimba[7] = 63.18181818181818;marimba[8] = 78.9090909090909;marimba[9] = 96.39393939393939;marimba[10] = 115.63636363636364;marimba[11] = 136.6060606060606;marimba[12] = 159.36363636363637;marimba[13] = 183.8181818181818;marimba[14] = 210.06060606060606;marimba[15] = 238.03030303030303;marimba[16] = 267.75757575757575;marimba[17] = 299.24242424242425;marimba[18] = 442.6363636363636;marimba[19] = 568.5454545454545;marimba[20] = 614.0;marimba[21] = 100000;marimba[22] = 100000;marimba[23] = 100000;marimba[24] = 100000;marimba[25] = 100000;marimba[26] = 100000;marimba[27] = 100000;marimba[28] = 100000;marimba[29] = 100000;marimba[30] = 100000;marimba[31] = 100000;marimba[32] = 100000;marimba[33] = 100000;marimba[34] = 100000;marimba[35] = 100000;marimba[36] = 100000;marimba[37] = 100000;marimba[38] = 100000;marimba[39] = 100000;marimba[40] = 100000;marimba[41] = 100000;marimba[42] = 100000;marimba[43] = 100000;marimba[44] = 100000;marimba[45] = 100000;marimba[46] = 100000;marimba[47] = 100000;marimba[48] = 100000;marimba[49] = 100000;marimba[50] = 100000;marimba[51] = 100000;marimba[52] = 100000;marimba[53] = 100000;marimba[54] = 100000;marimba[55] = 100000;marimba[56] = 100000;marimba[57] = 100000;marimba[58] = 100000;marimba[59] = 100000;marimba[60] = 100000;marimba[61] = 100000;marimba[62] = 100000;marimba[63] = 100000;

models = freemem; freemem += 7;
models[0] = string;
models[1] = beam;
models[2] = metal;
models[3] = membrane;
models[4] = plate;
models[5] = drumhead;
models[6] = marimba;

freemem = poly.array_init(freemem, 10, 5); // [note, velocity, freq, playback_speed]
freemem = midi.array_init(freemem, 256, 4); // [offset, status, note, vel, nsample]
clickl = freemem; freemem += 500000; // click left channel buffer
clickr = freemem; freemem += 500000; // click right channel buffer
wavebuf = freemem; // file reader buffer

function db2gain (db) local (val) (
  val = 10^(db / 20);
  val <= 0.001 ? 0 : val;
);
function rc_set(rc)
instance(a) (
  a = 1 / (rc * srate + 1);
);
function rc_lp(sample)
instance(lp, a) (
  lp += a * (sample - lp);
);
function smooth()
instance (lp, smooth) (
  lp = smooth;
  smooth = this.rc_lp(this);
);

function normalize_vol_slider(val) ( val * 75 / 100 - 60 );
function note2freq(n) ( 440 * pow(2, (n - 69) / 12); );

function read_file(filehandle)
local(i)
(
  filehandle > 0 ? (
    file_riff(filehandle, wavechn, wavesrate);
    wavechn ? (
      wavelen = file_avail(filehandle);
      file_mem(filehandle,wavebuf, min(wavelen, 500000));
    );
    file_close(filehandle);
    wavechn == 2 ? (
      wavelen = (wavelen / 2) | 0;
      i = 0; loop(wavelen,
        clickl[i] = wavebuf[i*2];
        clickr[i] = wavebuf[i*2+1];
        i += 1;
      );
    ) : (
      memcpy(clickl,wavebuf,wavelen);
      memcpy(clickr,wavebuf,wavelen);
    );
  );
);

function on_file_change() (
  lfile = slider1;
  filehandle=file_open(slider1);
  read_file(filehandle);
);

// init smooth
gain.rc_set(0.0033);
gain.smooth = db2gain(normalize_vol_slider(click_vol));


function modal_init(f_0, k, rel)
instance(b, a1, a2)
local(f_k, gamma_k, tone_gain, amp_k, decay_k, f_max, damp_k, inharm_k)
(
  inharm_k = sqrt(1 + inharm * (k-1) * (k-1));
  f_k = f_0 * k * inharm_k;
  f_max = f_0 * npartials * inharm_k;
  omega_k = 2 * $pi * f_k / srate;
  decay_k = rel ? decay * release / 100 : decay;

  damp_k = freq_damp <= 0
    ? pow(f_0 / f_k, freq_damp / 100 * 2)
    : pow(f_max / f_k, freq_damp / 100 * 2);

  // exp(-pi*2 / (srate*decay)) is set by hear and it approximates the decay time in seconds
  gamma_k = exp(($pi * -2 / (srate * decay_k)) * damp_k);

  (f_k < 0.48 * srate) ? (
    tone_gain = tone <= 0
      ? pow(f_k / f_0, tone * 12 / 100 / 6)
      : pow(f_k / f_max, tone * 12 / 100 / 6);
    amp_k = abs(sin($pi * k * hit_position / 100));
    b = gamma_k * amp_k * sin(omega_k) * tone_gain * sqrt(f_k) / 500;
    a1 = -2 * gamma_k * cos(omega_k);
    a2 = gamma_k * gamma_k;
    1
  ) : (
    b = a1 = a2 = 0;
    0
  );
);

function modal_init_ratio(f_0, k, ratio, rel)
instance(b, a1, a2)
local(f_k, gamma_k, tone_gain, amp_k, decay_k, f_max, damp_k, inharm_k)
(
  inharm_k = sqrt(1 + inharm * (k-1) * (k-1));
  f_k = f_0 * ratio * inharm_k;
  f_max = f_0 * npartials * inharm_k;
  omega_k = 2 * $pi * f_k / srate;
  decay_k = rel ? decay * release / 100 : decay;

  damp_k = freq_damp <= 0
    ? pow(f_0 / f_k, freq_damp / 100 * 2)
    : pow(f_max / f_k, freq_damp / 100 * 2);

  // exp(-pi*2 / (srate*decay)) is set by hear and it approximates the decay time in seconds
  gamma_k = exp(($pi * -2 / (srate * decay_k)) * damp_k);

  (f_k < 0.48 * srate) ? (
    tone_gain = tone <= 0
      ? pow(f_k / f_0, tone * 12 / 100 / 6)
      : pow(f_k / f_max, tone * 12 / 100 / 6);
    amp_k = abs(sin($pi * k * hit_position / 100));
    b = gamma_k * amp_k * sin(omega_k) * tone_gain * sqrt(f_k) / 500;
    a1 = -2 * gamma_k * cos(omega_k);
    a2 = gamma_k * gamma_k;
    1
  ) : (
    b = a1 = a2 = 0;
    0
  );
);

function modal_process(x)
instance(b, a1, a2, y, y1, y2)
(
  y = b * x - a1 * y1 - a2 * y2;
  y2 = y1;
  y1 = y;
  y
);

function on_slider()
(
  /*
  n = 0;
  bfree = 40000;
  bfree[0] = 1.50561873;
  bfree[1] = 2.49975267;
  bfree[2] = 3.5;
  loop(n=3; 64,
    bfree[n] = n + 0.5;
    n+=1;
  );

  n =0;
  loop(i=1; 8,
    loop(j=1; 8,
      membrane[n] = sqrt(i^2 + (ratio*j)^2);
      j+=1;
      n+=1;
    );
    i+=1;
  );


 fund = membrane[0];
 loop(k=0; 64,
    membrane[k] = membrane[k]/fund;
    k += 1;
 );
*/

  lfile != slider1 ? on_file_change();
  gain = db2gain(normalize_vol_slider(click_vol));
  inharm = inharmonic == 0.01 ? 0 : inharmonic / 100;
  playback_speed = 2^((click_pitch / 12) | 0);

  <?
    loop(i=1;npartials,
      printf("f%02d.modal_init_ratio(GLOBAL_FREQ, %d, models[model][%d], 0);\n", i, i, i-1);
      i += 1;
    );
  ?>
);

@slider

rel_pos = min(max(0.01, position / 100), 0.99);

on_slider();

@block
// remove queued midi messages that have been processed
ptr = midi.array_first();
while (ptr >= 0) (
  ptr[0] < 0 ? (
    midi.array_remove(ptr);
    ptr = midi.array_first();
  ) : (
    ptr = midi.array_next(ptr);
  );
);

while (midirecv(offset, msg1, note, vel)) (
  event = msg1 & 0xF0;
  channel = msg1 & 0x0F;

  // note on/off
  event == 0x90 || event == 0x80 ? (
    // prevent midi buffer overflow
    midi.size == 256 ? (
      midi.array_remove(midi.array_first());
    );
    ptr = midi.array_add();
    ptr[0] = offset;
    ptr[1] = msg1;
    ptr[2] = note;
    ptr[3] = vel;
  );

  // All notes off
  event == 0xB0 && note == 123 ? (
    poly.array_clear();
    //hold.array_clear();
  );

  midisend(offset, msg1, note, vel);
);

@sample
gain.smooth();
function on_note(p)
local (ptr, note_repeat, note, vel, env, freq)
(
  note = p[2];
  vel = p[3];

  // remove note if it is already playing
  ptr = poly.array_find(note);
  ptr >= 0 ? (
    poly.array_remove(ptr);
  );

  // if polyphony is full
  poly.size >= 12 ? (
    poly.array_remove(poly.array_first());
  );

  freq = note2freq(note);
  GLOBAL_FREQ = freq;
  ptr = poly.array_add();
  ptr[0] = note;
  ptr[1] = vel / 127;
  ptr[2] = freq / srate;
  ptr[3] = 0;
  ptr[4] = 2 ^ ((note - base_note) / 12);

  //<?
  //  loop(i=1;npartials,
  //    printf("f%02d.modal_init(freq, %d, 0);\n", i, i);
  //    i += 1;
  //  );
  //?>
  <?
    loop(i=1;npartials,
      printf("f%02d.modal_init_ratio(freq, %d, models[model][%d], 0);\n", i, i, i-1);
      i += 1;
    );
  ?>
);

function off_note(p)
local(ptr, note, pp, freq)
(
  note = p[2];
  ptr = poly.array_find(note);

  //<?
  //  loop(i=1;npartials,
  //    printf("f%02d.modal_init(GLOBAL_FREQ, %d, 1);\n", i, i);
  //    i += 1;
  //  );
  //?>
  <?
    loop(i=1;npartials,
      printf("f%02d.modal_init_ratio(GLOBAL_FREQ, %d, models[model][%d], 1);\n", i, i, i-1);
      i += 1;
    );
  ?>
);

function handle_midi(p)
local(msg1, vel, event)
(
  msg1 = p[1];
  vel = p[3];
  event = msg1 & 0xF0;
  event == 0x90 && vel ? on_note(p); // Note on
  event == 0x80 || (event == 0x90 && !vel) ? off_note(p); // Note off
);

/**
  Sample pos linear interpolation
*/
function wave_lerp(buf, pos)
local(x, i, j)
(
  i = pos|0;
  x = pos - i;
  j = i + 1;
  j >= wavelen ? j = 0;
  (1 - x) * buf[i] + x * buf[j];
);

// process queued midi
ptr = midi.array_first();
while(ptr >= 0) (
  ptr[0] == 0 ? ( // offset has reached zero
    handle_midi(ptr);
  );
  ptr[0] -= 1;
  ptr = midi.array_next(ptr);
);

// process notes being played
outl = 0;
outr = 0;
ptr = poly.array_first();
while(ptr >= 0) ( // for each note/voice
  outl = wave_lerp(clickl, ptr[3]) * gain;
  outr = wave_lerp(clickr, ptr[3]) * gain;
  ptr[3] += click_ktrack // samplepos += playback_speed
    ? ptr[4] * playback_speed
    : playback_speed;
  ptr[3] > wavelen ? ptr[3] = -1;
  ptr = poly.array_next(ptr);
);

outc = (outl + outr) / 2;
out_res = 0;

<?
  loop(i=1;npartials,
    printf("out_res += f%02d.modal_process(outc);\n", i);
    i += 1;
  );
?>

spl0 += out_res;
spl1 = spl0;

// remove notes that finish playing
ptr = poly.array_first();
while (ptr >= 0) (
  ptr[3] == -1 ? (
    poly.array_remove(ptr);
    ptr = poly.array_first();
  ) : (
    ptr = poly.array_next(ptr);
  );
);






